<!doctype html>
<html>
    <head>
    </head>
    <body>
        <div id="contenedor"></div>
        <script>
            function grafica(contenedor,datos,color){
                let colores =  []
                let colorbase = color
                for(let i = 0;i<100;i++){
                    let rojo = Math.abs(colorbase[0] + (Math.random()-0.5)*100)
                    let verde = Math.abs(colorbase[1] + (Math.random()-0.5)*100)
                    let azul = Math.abs(colorbase[2] + (Math.random()-0.5)*100)
                    colores.push("rgb("+rojo+","+verde+","+azul+")")
                }
                
                let suma = 0;
                Object.keys(datos).forEach(clave => {
                  suma += datos[clave]
                });
                console.log(suma);

                let anchura = 512;                                  // Defino una anchura
                let altura = anchura;                               // La altura es igual a la anchura
                let radio = anchura/2-30;                           // Defino el radio un poco menor para tener margen

                const lienzo = document.createElement("canvas");    // Llamo al lienzo
                const contexto = lienzo.getContext("2d");           // Dibujo en 2D

                lienzo.width = anchura;                             // Le pongo la anchura al lienzo
                lienzo.height = altura;                             // Le pongo la altura al lienzo

                //lienzo.style.border = "1px solid grey";             // Le pongo un borde al lienzo para verlo

                let cursor = 0
                let contador = 1;
                Object.keys(datos).forEach(clave => {               // Para cada uno de los elementos del json

                    contexto.fillStyle = colores[contador]                          // Voy a pintar de color rojo

                    let inicio = cursor                             // El inicio es el angulo en el que empiezo
                    let final = cursor + (datos[clave]/suma)*Math.PI*2  // El final es el angulo en el que acabo
                    cursor += (datos[clave]/suma)*Math.PI*2             // Actualizo el cursor para que el principio del siguiente angulo sea el final del angulo anterior

                    contexto.beginPath();                               // Inicio el trazo
                    contexto.moveTo(anchura/2,altura/2);                // Muevo el cursor al centro
                    contexto.arc(anchura/2,altura/2,radio,inicio,final); // Trazo el arco

                    contexto.fill();                                    // Y relleno
                    contador++;
                    
                    contexto.textAlign = "center"
                    
                    let ax = anchura/2+Math.cos(inicio+((final-inicio)/2))*radio/2
                    let ay = altura/2+Math.sin(inicio+((final-inicio)/2))*radio/2
                    contexto.fillStyle = "white"
                    /*contexto.beginPath();
                    contexto.arc(ax,ay,5,0,Math.PI*2)
                    contexto.fill()*/
                    
                    contexto.font = "15px sans-serif"
                    
                    contexto.fillText(clave+":"+datos[clave],ax,ay)

                });
                document.getElementById(contenedor).appendChild(lienzo)
            }
            
            fetch("057-origen.php")
                .then(function(response){
                    return response.json()
                })
                .then(function(datos){
                    grafica("contenedor",datos,[200,20,20]);
                })
            
            
            
            
            
            
                                
        </script>
    </body>
</html>